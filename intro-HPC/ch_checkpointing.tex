\chapter{Checkpointing}
\label{ch:checkpointing}

\section{What is checkpointing?}

If you want to run jobs that require more than 3 days (72 hours) of wall time,
and/or want to avoid you lose work because of power outages or system crashes,
you need to resort to checkpointing.

Checkpointing works by splitting the job in smaller parts (subjobs) that can be executed
consecutively. Each time a subjob is running out of requested wall time,
a snapshot of the application memory (and much more) is taken and stored,
after which a subsequent subjob will pick up the checkpoint and continue.

\section{How to use checkpointing}

Using checkpointing is simple: use the \lstinline|csub| command instead of \lstinline|qsub|.
Checkpointing doesn't require any changes to the application you are running,
and should support most software.

To submit a job with checkpointing:

\begin{prompt}
%\shellcmd{csub -s job\_script.sh}%
\end{prompt}

This will automatically take care of checkpointing, restoring checkpoints, \ldots

Note that \lstinline|csub| will ignore most parameters specified in the jobscript.
It will however use the \lstinline|#PBS -N <name>| (job name) and most \lstinline|#PBS -l|
directives (e.g. \lstinline|nodes|, \lstinline|ppn|, \lstinline|vmem| (virtual memory limit),
\ldots). Other parameters (like walltime) should be specified on the \lstinline|csub|
command line.

\section{Checkpointing parameters}

\subsection{Job wall time}

The most important option for \lstinline|csub| is the \lstinline|--job_time| option: it sets the amount
of walltime your subjobs will run for before they get checkpointed. By default, this
is 10 hours: that means that a subjob will run for 10 hours, then it gets checkpointed,
a new subjob starts from the checkpoint, runs for another 10 hours and so on, until
your job finishes.

\subsection{Local files}

The \lstinline|--pre| and \lstinline|--post| parameters steer whether local files are copied or not.
The job submitted using \lstinline|csub| is (by default) run on the local storage provided
by a particular workernode. Thus, no changes will be made to the files on the
shared storage (e.g. \texttt{\$VSC_SCRATCH}).

\section{Similarities and differenes}

\subsection{Similarities with qsub}

\begin{enumerate}
    \item Specifying the cluster to which the job will be submitted
    \item Array jobs (with the \lstinline|-t| flag)
    \item Most \lstinline|#PBS| directives
\end{enumerate}


\subsection{Differences with qsub}

\begin{enumerate}
    \item By default, \lstinline|csub| will not copy stdout and stderr to the directory
        the job was submitted from by default. You can enable copying the results
        by adding the \lstinline|--post| option to \lstinline|csub|.
    \item
\end{enumerate}
